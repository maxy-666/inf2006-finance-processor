cd<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Upload Document → AWS Textract Viewer</title>
  <style>
    body { font-family: system-ui, -apple-system, 'Segoe UI', Roboto, Arial; max-width:1000px; margin:2rem auto; padding:1rem; }
    .card { border:1px solid #e5e7eb; padding:1rem; border-radius:8px; box-shadow: 0 1px 3px rgba(0,0,0,0.04); }
    table { width:100%; border-collapse:collapse; margin-top:1rem; }
    th, td { padding:8px; border-bottom:1px solid #eee; text-align:left; }
    .muted { color:#6b7280; }
    #preview { max-width:100%; margin-top:10px; border:1px solid #ccc; }
    #loader { display:none; }
    pre { background-color: #f4f4f4; padding: 10px; border-radius: 4px; white-space: pre-wrap; word-wrap: break-word; }
  </style>
</head>
<body>
  <h1>AWS Textract — Upload & View OCR</h1>
  <div class="card">
    <p class="muted">Choose an image (PNG/JPG) for synchronous OCR. PDFs are uploaded but require async processing (not handled here).</p>
    <form id="uploadForm">
      <input type="file" id="fileInput" name="document" accept="image/*,application/pdf" required />
      <div style="margin-top:8px">
        <button type="submit">Upload & Extract</button>
        <span id="loader">Processing…</span>
      </div>
    </form>

    <img id="preview" alt="Image preview" style="display:none;" />

    <div id="result"></div>
  </div>

<script>
    // === PASTE YOUR API URL HERE ===
    const API_ENDPOINT = 'https://qcglc0j7e2.execute-api.us-east-1.amazonaws.com/';
    // ===============================

    const form = document.getElementById('uploadForm');
    const fileInput = document.getElementById('fileInput');
    const preview = document.getElementById('preview');
    const resultDiv = document.getElementById('result');
    const loader = document.getElementById('loader');

    fileInput.addEventListener('change', (e) => {
      const f = e.target.files[0];
      if (!f) return;
      if (f.type.startsWith('image/')) {
        const url = URL.createObjectURL(f);
        preview.src = url;
        preview.style.display = 'block';
      } else {
        preview.style.display = 'none';
      }
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const file = fileInput.files[0];
      if (!file) return alert('Choose a file first');

      loader.style.display = 'inline';
      resultDiv.innerHTML = '<pre>1. Requesting secure upload link...</pre>';

      try {
        // --- THIS IS THE CHANGE ---
        // We now pass the file's content type as a query parameter.
        const contentType = encodeURIComponent(file.type);
        const getUrlResponse = await fetch(`${API_ENDPOINT}/generate-upload-url?contentType=${contentType}`, { method: 'GET' });
        // --------------------------
        
        if (!getUrlResponse.ok) {
            const errorText = await getUrlResponse.text();
            throw new Error(`Could not get an upload URL. Status: ${getUrlResponse.status}. Message: ${errorText}`);
        }

        const { uploadURL } = await getUrlResponse.json();
        resultDiv.innerHTML += '<pre>2. Received upload link. Now uploading file directly to S3...</pre>';

        const uploadResponse = await fetch(uploadURL, {
            method: 'PUT',
            body: file,
            headers: { 'Content-Type': file.type }
        });

        if (!uploadResponse.ok) {
            throw new Error('S3 upload failed. Check the console for details.');
        }

        loader.style.display = 'none';
        resultDiv.innerHTML += `<pre style="color:green; font-weight:bold;">3. Upload successful! Backend processing has been triggered. Check the Step Functions console.</pre>`;
        
      } catch (err) {
        loader.style.display = 'none';
        resultDiv.innerHTML = `<pre style="color:red">Error: ${err.message}</pre>`;
      }
    });
  </script>

  <hr style="margin-top:2rem">
  <div class="muted">Notes: This is a minimal demo. For production: add authentication, file type/size limits, and server-side validation. To process invoices/tables more accurately, use Textract's AnalyzeDocument with TABLES + FORMS.</div>
</body>
</html>